import os # To get access to files
import pickle # Save data as bytes to save space
from tkinter import filedialog as fd # To browse and select files
import tkinter as tk # To create graphical interface
from tkinter import ttk # To create tabs in the interface
from file_read_backwards import FileReadBackwards # Allows to read file backwards in memory-efficient way
from filenamer import FileNamer # Names files based on input
from filetextextractor import FileTextExtractor # To extract text from files
from gaussiantoorca import GaussianToOrca # Translate Gaussian to ORCA file format
from filevariableextractor import FileVariableExtractor # To get variables for naming convention

class gaussianDataTool():

    def __init__(self):
        self.PROGRAM_DATA = 'GDTData/GDTData.txt'
        self.saveFileLoc = None
        self.saveFileLocIdx = 0
        self.newUser = False
        self.cont = True

        # Initialize
        if not os.path.exists(self.PROGRAM_DATA):
            checkPaths()
        else:
            self.loadData()
        if self.newUser:
            self.promptSaveLoc()

    def checkPaths(self):
        # Initialize paths for data
        programDir = self.PROGRAM_DATA.split('/')[0]
        if not os.path.exists(programDir):
            os.mkdir(programDir)
        open(self.PROGRAM_DATA, 'x').close()
        self.saveData()
        self.newUser = True
            
    def loadData(self):
        loadList = pickle.load(open(self.PROGRAM_DATA, 'rb'))
        self.saveFileLoc = loadList[self.saveFileLocIdx]
        if self.saveFileLoc == None:
            self.newUser = True


    def saveData(self, saveLocation=None):
        saveList = [self.saveFileLoc]
        pickle.dump(saveList, open(self.PROGRAM_DATA, 'wb'))
        

    def chooseProgram():
        '''Creates interface for the user to select whether they want
            to create Gaussian or ORCA input files'''

        def startGausInput():
            self.gaussInterface()
            window.destroy()
        def startOrcaInput():
            self.orcaInterface()
            window.destroy()
        
        borderWidth = 3
        horizontalPad = 3
        verticalPad = 3
        
        window = tk.Tk()
        frame = tk.Frame(master=window, relief=tk.RAISED, borderwidth=borderWidth)
        displayStr = 'Please choose which files you want to make'

        disLabel = tk.Label(master=frame, text=displayStr, padx=100, pady=5)
        frame.grid(row=0, col=1, padx=horizontalPad, pady=verticalPad)
        disLabel.pack()

        gausIn = tk.Button(master=frame, text='Gaussian Input')
        frame.grid(row=1, col=0, padx=horizontalPad, pady=verticalPad)
        gausIn.pack()

        orcaIn = tk.Button(master=frame, text='ORCA Input')
        frame.grid(row=1, col=3, padx=horizontalPad, pady=verticalPad)
        gausIn.pack()

        window.mainloop()


    def createInterface(self):
        """ Creates the main visual interface for the program """        
        borderWidth = 3
        horizontalPad = 3
        verticalPad = 3

        self.mainWindow = tk.Tk()

        # Make multiple tabs
        tabManager = ttk.Notebook(self.mainWindow)
        tabManager.pack(pady=10, expand=True)

        # General Info. Tab
        genFrame = ttk.Frame(master=tabManager, relief=tk.RAISED, borderwidth=borderWidth)

        # Make a list of elements in interface to add in order
        genElements = list()
        # Create Label and Button to select files
        selFileLabel = tk.Label(master=genFrame, text="Select the Gaussian files", \
                                padx=100, pady=5)    
        genElements.append(selFileLabel)
        selFileDisplay = tk.Label(master=genFrame, text='Selected File(s)', padx=100, pady=5)
        genElements.append(selFileDisplay)
        selFileButton = tk.Button(master=genFrame, text="Select Files", \
                                  command=lambda:self.selectFiles(selFileDisplay))
        genElements.append(selFileButton)

        startButton = tk.Button(master=genFrame, text="Start", command=self.convertToOrca)
        genElements.append(startButton)
        # Add each element in order
        row = 0
        col = 0
        for element in genElements:
            genFrame.grid(row=row, column=col, padx=horizontalPad, pady=verticalPad)
            element.pack()
            row += 1
        # END: General Info. Tab
        # Advanced Tab
        advFrame = ttk.Frame(master=tabManager, relief=tk.RAISED, borderwidth=borderWidth)
        # List of elements for advanced tab
        advElements = list()
        # Create labels and buttons
        saveFileLabel = tk.Label(master=advFrame, text="Save Location:", padx=100, pady=5)
        advElements.append(saveFileLabel)
        saveFileDisplay = tk.Label(master=advFrame, text='Save Location', padx=100, pady=5)
        advElements.append(saveFileDisplay)
        saveFileButton = tk.Button(master=advFrame, text="Select Location", \
                                   command=lambda:self.selectFiles(saveFileDisplay, True))
        advElements.append(saveFileButton)
        
        # Add each element in order
        row = 0
        col = 0
        for element in advElements:
            advFrame.grid(row=row, column=col, padx=horizontalPad, pady=verticalPad)
            element.pack()
            row += 1
        # Add both tabs to the main window
        tabManager.add(genFrame, text="General")
        tabManager.add(advFrame, text="Advanced")
        # Show main interface
        self.mainWindow.mainloop()


    def checkFiles(self, aFileList):
        '''Returns true if all files in aFileList are .gjf files.
            Returns false otherwise'''
        gaussianStart = ' Entering Gaussian System'
        for file in aFileList:
            with open(file, 'r') as rFile:
                if gaussianStart not in rFile.readline()[:len(gaussianStart)]:
                    return False
        return True
        

    def selectFiles(self, displayLabel, settingSaveLoc=False):
        '''Opens dialog to select one or more files and saves the list of
            files to the global variable selectedFileList'''
        validFiles = False
        if not settingSaveLoc:
            while not validFiles and self.cont:
                # askopenfilenames() allows multiple files to be selected and returns a list of strings
                self.selectedFileList = fd.askopenfilenames()
                validFiles = self.checkFiles(self.selectedFileList)
                print(validFiles)
                print(self.selectedFileList)
                if not validFiles:
                    self.popup("At least one of the files selected is not a '.gjf' file. Please select files again.")
                elif len(self.selectedFileList) == 0:
                    validFiles = False
                    self.popup("You haven't selected any files")
            if validFiles:
                displayStr = ", ".join(self.selectedFileList)
                displayLabel['text'] = displayStr
        else:
            # ask directory to save the ORCA files to 
            self.saveFileLoc = fd.askdirectory()
            displayLabel['text'] = self.saveFileLoc
            self.saveData()


    def convertToOrca(self):
        """ Extracts the desired data from the Gaussian output files and converts to ORCA data"""
        primaryMarker = " ***"
        marker = " ------"
        jobNameMarker = ' (Enter'
        atomMarker = " Charge"
        endAtomMarker = " Add"
        for aFile in self.selectedFileList:
            dataFound = False
            atomsFound = False
            dataRecorded = False
            with FileReadBackwards(aFile, encoding="utf-8") as frb:
                extractor = FileTextExtractor(marker, frb)
                for i in range(2):
                    extractor.passText(primaryMarker)
                dataReversed = extractor.extractText()
                data = list(reversed(dataReversed))
            with open(aFile, 'r') as file:
                extractor = FileTextExtractor([atomMarker, endAtomMarker], file)
                extractor.passText(jobNameMarker)
                for i in range(2):
                    extractor.nextLine()
                jobName = extractor.getCurLine().strip()
                atomLines = extractor.extractText()
            
            atoms = list()
            for aLine in atomLines:
                if aLine != "":
                    atomName = aLine[0]
                    atoms.append(atomName)
            # Change lines to ORCA input data
            orcaConverter = GaussianToOrca(data, atoms)
            orcaData = orcaConverter.translate()
            self.writeFile(self.nameFile(jobName), orcaData)
            

    def nameFile(self, aJobName):
        '''Names files based on used job name'''
        return aJobName + '_ORCA.inp'


    def writeFile(self, aFile, aFileData):
        with open(self.saveFileLoc + '/' + aFile, 'w') as newFile:
            for line in aFileData:
                newFile.write(line + '\n')
        

    def promptSaveLoc(self):
        '''Prompts new user to select a save location for created ORCA
            input files to go'''
        borderWidth = 3
        horizontalPad = 3
        verticalPad = 3

        popup = tk.Tk()
        promptText = "Before getting started, select a directory where you'd like your ORCA input files to go"
        elements = list()
        frame = ttk.Frame(master=popup, relief=tk.RAISED, borderwidth=borderWidth)
        promptLabel = tk.Label(master=frame, text=promptText, padx=100, pady=5)
        elements.append(promptLabel)
        saveLocDisplay = tk.Label(master=frame, padx=100, pady=5)
        elements.append(saveLocDisplay)
        saveLocBtn = tk.Button(master=frame, text='Select Location', command=lambda:self.selectFiles(saveLocDisplay, True))
        elements.append(saveLocBtn)
        doneBtn = tk.Button(master=frame, text='Done', command=lambda:popup.destroy())
        elements.append(doneBtn)
        # Add each element in order
        row = 0
        col = 0
        for element in elements:
            frame.grid(row=row, column=col, padx=horizontalPad, pady=verticalPad)
            element.pack()
            row += 1
            
        popup.mainloop()


    def popup(self, displayText):
        '''Creates a popup with the displayText'''

        def canc():
            global mainWindow
            global cont
            self.cont = False
            self.mainWindow.destroy()
            popup.destroy()

        borderWidth = 3
        horizontalPad = 3
        verticalPad = 3

        popup = tk.Tk()
        elements = list()
        frame = ttk.Frame(master=popup, relief=tk.RAISED, borderwidth=borderWidth)
        promptLabel = tk.Label(master=frame, text=displayText, padx=100, pady=5)
        elements.append(promptLabel)
        contBtn = tk.Button(master=frame, text='Continue', command=lambda:popup.destroy())
        elements.append(contBtn)
        cancBtn = tk.Button(master=frame, text='Cancel', command=lambda:canc())
        elements.append(cancBtn)
        # Add each element in order
        row = 0
        col = 0
        for element in elements:
            frame.grid(row=row, column=col, padx=horizontalPad, pady=verticalPad)
            element.pack()
            row += 1
            
        popup.mainloop()
        
        
def main():
    dataTool = gaussianDataTool()
    dataTool.createInterface()
        
        
# Allows program to run as executable
if __name__ == "__main__":
    main()
